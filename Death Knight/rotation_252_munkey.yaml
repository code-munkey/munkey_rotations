version: 1
author: munkey
spec: 252
name: Unholy Midnight
description: "Optimized Unholy Death Knight rotation by munkey. Includes Reanimation/Magus sync logic and Festering Scythe maintenance."

config:
  force_raid:
    label: "Force raid rotation"
    type: checkbox
    default: true

variables:
  casting_idol: (trinket_2.id=246344&trinket_2.cd>0&trinket_2.cd<1)|(trinket_1.id=246344&trinket_1.cd>0&trinket_1.cd<1)
  is_aoe: state.aoe&enemies.combat.8y>2
  is_st: state.aoe=false|enemies.combat.8y<=2

lists:
  use_trinkets:
    - trinket_1,if=state.cds&trinket_1.usable&trinket_1.ready,global_delay=100
    - trinket_2,if=state.cds&trinket_2.usable&trinket_2.ready,global_delay=100
  rotation:
    - outbreak,if=target.debuff.remains(virulent_plague)=0
    - call_action_list,name=use_trinkets,if=state.cds,global_delay=100
    - return,if=var.casting_idol
    - army_of_the_dead,if=state.cds
    - dark_transformation,if=state.cds
    - soul_reaper
    - putrefy,if=(cooldown.putrefy.charges=2|buff.commander_of_the_dead.up|cooldown.putrefy.full_recharge_time<cooldown.dark_transformation.remains)
    - scourge_strike,if=buff.1254252.stacks>0
    - death_coil,if=(buff.sudden_doom.react|runic_power>=80)&var.is_st
    - epidemic,if=(buff.sudden_doom.react|runic_power>=80)&var.is_aoe
    - festering_scythe,override=festering_strike,if=debuff.1241077.remains<5|cooldown.festering_scythe.ready
    - festering_strike
    - death_coil,if=var.is_st
    - epidemic,if=var.is_aoe

  main:
    - return,if=!state.rotation
    - augment_rune,if=buff.ethereal_augmentation.remains<300
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_target
    - return,if=!player.combat
    - return,if=player.channeling
    
    # Defensives and Utility
    - call_action_list,name=defensives

    # Interrupts
    - mind_freeze,if=interrupts.target.ready
    - mind_freeze.mouseover,if=interrupts.mouseover.ready
    - death_grip,if=interrupts.target.ready
    - death_grip.mouseover,if=interrupts.mouseover.ready

    # Rotation Dispatch
    - call_action_list,name=rotation

  defensives:
    - icebound_fortitude,if=player.health.pct<35|player.stunned
    - death_strike,if=player.health.pct<50
    - death_pact,if=player.health.pct<20
    - lichborne,if=player.health.pct<30&talent.unholy_endurance